/* backbone-lifeguard - v0.1.0 - 2012-06-28 */
(function(a){function m(a){var c=this;return a===null||b["is"+c._type](a)}function n(a){var b=this;return a===null||a instanceof b.type}function o(a){var b=a,c=this;return a===null?null:(a instanceof c.type||(b=new c.type(a)),b)}var b=a._||require("underscore"),c=a.Backbone||require("backbone"),d=c.Model,e=d.extend,f=d.prototype,g=f.set,h=f._validate,i=f.isValid,j=f.toJSON,k=c.Collection,l=Object.prototype.toString,p={string:{_type:"String",_typeCheck:m},number:{_type:"Number",_typeCheck:m},array:{_type:"Array",_typeCheck:m},object:{_type:"Object",_typeCheck:m},"boolean":{_type:"Boolean",_typeCheck:m},regexp:{_type:"RegExp",transform:function(a){var c=a,d=/^\/(.*)\/([gimy]*)$/,e;return b.isString(a)&&(e=d.exec(a),e&&(c=new RegExp(e[1],e[2]))),c},_typeCheck:m},date:{_type:"Date",transform:function(a){var c=a;return b.isString(a)&&(c=new Date(a),isNaN(c.valueOf())&&(c=void 0)),c},_typeCheck:m},integer:{_type:"Number"},"class":{_type:"class",transform:o,_typeCheck:n},model:{_type:"model",transform:o,_typeCheck:n},collection:{_type:"collection",transform:o,_typeCheck:n}},q=["class","model","collection"],r={_validate:function(a,c){var d=this,e=d.fields,f=[],g;return b.each(a,function(c,d){var h=e[d],i=c;if(h){b.isFunction(h.transform)&&(i=h.transform(i));if(b.isFunction(h.validate)){g=h.validate(i);if(g){f.push(g);return}}if(b.isFunction(h._typeCheck)){g=!h._typeCheck(i);if(g){f.push('Error: Failed type check for attribute "'+d+'".');return}}a[d]=i}else f.push('Error: Undeclared attribute "'+d+'".')}),b.isEmpty(f)?h.call(d,a,c):(c&&c.error?c.error(d,f,c):d.trigger("error",d,f,c),!1)},toJSON:function(a){var b=this;return j.call(b,a)}};d.extend=function(a,c){var g=a&&a.defaults||{},h=a&&a.fields;return h&&b.isObject(h)&&(b.each(h,function(a,c){var e,f,h;if(!b.isObject(a))throw new Error('Backbone-Lifeguard cannot be initialized: "fields" must contain only objects.');b.has(a,"defaultValue")&&!b.has(g,c)&&(g[c]=a.defaultValue);if(b.has(a,"type")){e=a.type;if(b.isString(e)){f=e.toLowerCase();if(b.contains(q,f))throw new Error('Backbone-lifeguard cannot be initialized: reserved type for attribute "'+c+'".')}else if(b.isFunction(e))f=l.call(e.prototype).slice(8,-1).toLowerCase();else throw new Error('Backbone-lifeguard cannot be initialized: unrecognizable type for attribute "'+c+'".');f==="function"&&(e.prototype instanceof d?f="_model":e.prototype instanceof k?f="_collection":f="_class"),h=p[f];if(h)b.defaults(a,h);else throw new Error('Backbone-lifeguard cannot be initialized: unsupported data type for attribute "'+c+'".')}}),b.each(g,function(a,c){var d=this;if(!b.has(h,c))h[c]={defaultValue:a};else if(h[c].defaultValue!==a)return d.trigger("error",d,c),null}),a.defaults=g,a.fields=h,b.extend(f,r)),e.call(d,a,c)}})(this);